<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Using JBrowse Circular Genome View</title>
    <!-- The commented scripts below are the minified production versions of the
      other scripts -->
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin="anonymous"></script>
    <!--    <script src="https://unpkg.com/@jbrowse/react-circular-genome-view/dist/react-circular-genome-view.umd.development.js"
                crossorigin="anonymous"></script>-->
    <script
            src = "https://unpkg.com/@jbrowse/react-circular-genome-view/dist/react-circular-genome-view.umd.production.min.js"
            crossorigin="anonymous"
    ></script>

    <!--    <script src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/@jbrowse/react-circular-genome-view/dist/react-circular-genome-view.umd.production.min.js"
                crossorigin></script>-->

</head>
<body>

<div id="igvDiv"></div>

<div id="jbrowse_circular_genome_view" style="z-index: 2048; position: absolute; top:0; left:0;width: 450px; height: 450px;"></div>

<script type="module">

    import {makeDraggable} from '../../node_modules/igv-utils/src/index.js'
    import igv from "../../js/index.js";
    import CircularView from "../../js/jbrowse/CircularView.js";

    // Start igv.js and create regions
    var options =
        {
            genome: "hg19",
            //locus: "chr17:64,040,802-64,045,633",
            tracks: [
                {
                    id: 'bedpe-track',
                    name: "SKBR3 translocations",
                    url: "SKBR3_Sniffles_variants_tra.bedpe",
                    color: "rgb(0,150,150)",
                    height: 300,
                    onclick: (features, e) => {
                        if (e.shiftKey) {
                            if (features) {
                                sendBedPEChords(features);
                            }
                            return true;
                        } else {
                            return false;
                        }
                    }
                },
                {
                    name: "Coverage",
                    type: "wig",
                    format: "tdf",
                    max: 300,
                    color: "rgb(80,80,80)",
                    url: "../../Downloads/skbr3/SKBR3_550bp_pcrFREE_S1_L001_AND_L002_R1_001.101bp.bwamem.ill.mapped.sort.bam.tdf"

                },
                // {
                //     name: "sniffles deletions",
                //     url: "SKBR3_Sniffles_variants_del.bedpe",
                //     height: 40,
                //   //  color: "rgb(0,0,150)"
                // },
                // {
                //     url: "../../Downloads/skbr3/sniffles_del.vcf",
                //     type: "variant",
                //     format: "vcf",
                //     name: "sniffles deletions",
                //     supportsWholeGenome: true,
                //     visibilityWindow: -1,
                //     showGenotypes: false,
                //     height: 40
                // },
                // {
                //     name: "delly translocations",
                //     url: "SKBR3_Illumina_delly.tra.pass.bedpe",
                //     height: 40,
                //     color: "rgb(0,150,0)"
                // },
                // {
                //     id: "delly",
                //     url: "SKBR3_Illumina_delly.tra.pass.vcf",
                //     type: "variant",
                //     format: "vcf",
                //     name: "delly",
                //     supportsWholeGenome: true,
                //     visibilityWindow: -1,
                //     showGenotypes: false,
                //     height: 40
                // },

                {
                    // url: "https://s3.amazonaws.com/igv.org.demo/SKBR3/SKBR3_Illumina_delly.tra.pass.bam",
                    // indexURL: "https://s3.amazonaws.com/igv.org.demo/SKBR3/SKBR3_Illumina_delly.tra.pass.bam.bai",
                    url: "../../Downloads/skbr3/SKBR3_550bp_pcrFREE_S1_L001_AND_L002_R1_001.101bp.bwamem.ill.mapped.sort.bam",
                    indexURL: "../../Downloads/skbr3/SKBR3_550bp_pcrFREE_S1_L001_AND_L002_R1_001.101bp.bwamem.ill.mapped.sort.bam.bai",
                    type: "alignment",
                    format: "bam",
                    name: "Alignments",
                    showMismatches: false,
                    height: 500,
                    maxFragmentLength: 1000000,  // 1 mb -- only interested in large deletions
                    colorBy: "fragmentLength",
                    onclick: (features, e) => {
                        if (e.shiftKey) {
                            if (features) {
                                sendPairedAlignmentChord(features);
                            }
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
            ]
        };

    var igvDiv = document.getElementById("igvDiv");

    let circularView;
    igv.createBrowser(igvDiv, options)
        .then(async function (browser) {

            console.log("Created IGV browser");
            window.igvBrowser = browser;

            const el = document.getElementById('jbrowse_circular_genome_view')
            makeDraggable(el, el)
            circularView = new CircularView(el, browser);
            browser.circularView = circularView;


            document.addEventListener('keydown', logKey);

            function logKey(e) {
                switch (e.key) {
                    case '1' :
                        circularView.clearChords();
                        break;
                    case '2':
                        for(let t of browser.findTracks('id', 'bedpe-track')) {
                            t.height = 30;
                            t.trackView.setTrackHeight(30, true);
                            t.trackView.checkContentHeight();
                            t.trackView.repaintViews();

                           for(let tv of browser.trackViews) {
                               if (typeof tv.track.paintAxis === 'function') {
                                   tv.paintAxis();
                               }
                           }
                        }
                        break;
                }
            }


        })

    // individual clicked-on alignments
    function sendPairedAlignmentChord(features) {
        circularView.selectAlignmentChord(features[0]);
    }

    function sendBedPEChords(features) {
        circularView.addBedPEChords(features);
    }

</script>

</body>
</html>
